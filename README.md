# 🧠 AI 주식 자동매매 시스템

## 개요
Python 3.x와 PyQt5로 구현된 AI 자동매매 플랫폼으로, **Kiwoom OpenAPI+ REST API**만을 사용해 멀티타임프레임 캔들 데이터(틱~6시간), 수급 데이터(외인·기관·대차잔고)와 시장지수를 수집합니다. 감독학습 모델이 종목을 선별하고 강화학습 정책이 매수/매도/홀딩 결정을 수행하며, 모든 전략 제어는 PyQt5 GUI에서 버튼·토글·선택창으로 진행됩니다. 실계좌/모의계좌 전환, `app_sky`·`sec_key` 입력, 안전 제한 설정까지 GUI에서 처리하도록 설계해 비개발자도 사용할 수 있습니다.

## 주요 기능
- **Kiwoom REST 전문 게이트웨이**: 세션 관리·재시도·호가단위 보정까지 REST 호출로 일원화.
- **GUI 기반 전략 제어**: 시간 프레임, 종목 풀, 모델 버전 선택을 버튼/콤보박스에서 지정(추가 명령행 옵션 불필요).
- **자격 증명 입력 패널**: 초기 실행 시 `app_sky`, `sec_key`, 계좌 비밀번호를 암호화 저장 후 필요 시 재입력.
- **감독/강화학습 결합 엔진**: LightGBM/TabNet으로 종목 랭킹, PPO·SAC 정책으로 포지션 컨트롤, 과매매 방지 쿨다운.
- **리스크 및 알림**: 일손실·종목비중·슬리피지 한도를 GUI 슬라이더로 설정하고 Slack/Telegram/Webhook으로 알림.
- **백테스트/리플레이 보드**: GUI에서 날짜 범위와 전략 구성을 선택 후 재생, 주요 성과지표를 자동 집계.

## 시스템 아키텍처
```
시세·수급·지수 데이터
        │
ETL & 피처 엔진 ──► 시계열 피처 스토어 ──► 감독학습 모델 서비스
        │                                       │
        └────► 강화학습 환경 ──► 정책 네트워크 ─┘
                         │
PyQt5 GUI (버튼/토글) ──► 전략 오케스트레이터 ──► Kiwoom REST 주문 게이트웨이
                         │
                실계좌 / 모의계좌 안전 스위치
```
- **데이터 계층**: `src/data_pipeline`이 REST 기반 수집 스케줄러, 멀티타임프레임 파서, 피처 캐시(`feature_store.py`)를 포함합니다.
- **AI 계층**: `src/models/supervised`와 `src/models/rl`이 각각 종목 추천과 포지션 제어 모델을 제공하며, GUI에서 버전을 선택해 로드합니다.
- **전략/주문 계층**: `src/core/strategy`가 시그널을 융합하고, `src/api/kiwoom_client.py`가 REST 호출, `src/risk`가 주문 전 검증을 수행합니다.
- **UI & 서비스 계층**: `src/ui`가 입력창, 버튼, 시각화를 제공하며 `src/services`가 백테스트, 알림, 태스크 스케줄링을 담당합니다.

## 설치 방법
1. Python 3.10 이상과 Kiwoom OpenAPI+ (REST) 환경을 설정합니다.
2. 저장소 클론 후 가상환경 구성:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows PowerShell: .\.venv\Scripts\Activate.ps1
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
3. `.env`에는 기본값만 넣고, 실제 `app_sky`, `sec_key`는 GUI 입력창에 저장하도록 권장합니다:
   ```bash
   KIWOOM_APP_KEY_PLACEHOLDER=fill_via_gui
   KIWOOM_ACCOUNT_NO=1234567890
   ```
4. Windows에서는 Qt 런타임/VC++ 재배포 패키지를 준비하고, PyQt5가 GPU 드라이버와 충돌하지 않도록 최신 그래픽 드라이버를 유지합니다.

## 프로젝트 폴더 구조
```
MLStock/
├── README.md
├── requirements.txt
├── data/
│   ├── raw/                  # 원천 캔들·수급 데이터
│   └── processed/            # 정제/스케일링 결과
├── notebooks/                # EDA 및 전략 실험
├── logs/
│   ├── app/                  # 애플리케이션 로그
│   └── trades/               # 주문·체결 트레이스
├── saved_models/
│   ├── supervised/
│   └── rl/
├── configs/
│   ├── data_sources.yaml
│   ├── features.yaml
│   └── risk.yaml
├── src/
│   ├── api/
│   │   └── kiwoom_client.py
│   ├── core/
│   │   ├── scheduler.py
│   │   └── strategy.py
│   ├── data_pipeline/
│   │   ├── collectors/
│   │   └── feature_store.py
│   ├── models/
│   │   ├── supervised/
│   │   └── rl/
│   ├── risk/
│   │   └── guardrails.py
│   ├── services/
│   │   ├── backtester.py
│   │   └── notifier.py
│   ├── ui/
│   │   ├── main_window.py
│   │   └── components/
│   └── main.py
└── tests/
    ├── unit/
    └── integration/
```

## 사용법 (버튼별 기능 설명 포함)
1. **애플리케이션 실행**
   ```bash
   python -m src.main
   ```
   - 실행 후 나타나는 로그인 모달에서 `app_sky`, `sec_key`, 계좌번호, OTP를 입력합니다. 입력값은 로컬 암호화 스토어(`data/secure_config.json`)에 저장되어 다음 실행 시 GUI에서 불러오고 재확인합니다.
2. **GUI 탭 구성**
   - **연결 & 계좌 탭**: `REST 연결` 버튼으로 세션을 생성하고 `계좌 선택` 드롭다운에서 실계좌/모의계좌를 토글합니다.
   - **데이터 & 피처 탭**: `타임프레임 선택` 콤보박스(틱~6시간)와 `수급 데이터 체크박스`를 선택 후 `동기화 시작` 버튼을 누르면 ETL 파이프라인이 실행됩니다.
   - **모델 탭**: `감독학습 모델`/`강화학습 정책` 리스트에서 버전을 고른 뒤 `로드` 버튼으로 활성화합니다. `학습 요청` 버튼은 스케줄러에 잡을 등록해 서버 사이드에서 훈련을 수행하며 진행상황이 GUI에 갱신됩니다.
   - **자동매매 탭**: `모의/실계좌 토글`, `자동매매 시작`, `즉시 정지`, `과매매 쿨다운 재설정` 버튼으로 전략을 제어합니다.
   - **백테스트 & 리플레이 탭**: 기간 선택 달력과 전략 프로필을 고른 후 `재생` 버튼을 누르면 결과가 하단 카드로 출력됩니다.
3. **버튼별 세부 기능**
   - `REST 연결`: 입력된 `app_sky`·`sec_key`로 토큰을 발급하고 만료 전 자동 갱신.
   - `동기화 시작`: 멀티타임프레임 수집 및 피처 생성 파이프라인 실행, 진행률 표시.
   - `모델 로드`: 선택된 감독/강화 모델을 메모리에 적재하고 신뢰도 스코어를 표시.
   - `학습 요청`: 선택한 데이터 뷰/하이퍼파라미터를 큐에 넣고 완료 시 알림.
   - `자동매매 시작`: 전략 오케스트레이터와 리스크 엔진을 활성화, 실시간 체결 패널 표시.
   - `긴급 정지`: 주문 큐를 비우고 모든 세션을 종료.
   - `리스크 한도`: 슬라이더/입력칸으로 일손실, 종목 비중, 슬리피지 허용치를 조정.
   - `알림 채널`: Slack, Telegram, Webhook 토글과 메시지 템플릿 점검.
4. **안전 장치**
   - 실계좌 전환 시 다중 확인 + OTP + 30초 쿨다운.
   - `risk.guardrails`가 주문 수량, 평균단가 괴리, 과매매 카운트를 실시간 차단.
   - REST 오류·연결 끊김 발생 시 GUI 팝업과 알림 채널로 즉시 통보.

## 개발 단계 및 로드맵
1. **Phase 0 – 인프라 준비**: 데이터 소스 커넥터, REST 인증 래퍼, 공통 로깅/알림 프레임 구축.
2. **Phase 1 – 데이터 & 피처 엔진**: 멀티타임프레임 수집 안정화, 수급·시장지수 결합, 피처 카탈로그 작성.
3. **Phase 2 – 모델링**: 감독학습 파이프라인 자동화, RL 환경 시뮬레이터 정교화, 모델 버전 관리.
4. **Phase 3 – 백테스트 & 리플레이**: 이벤트 드리븐 백테스터, 거래비용/슬리피지 모델, GUI 리포트 카드.
5. **Phase 4 – GUI & 사용자 흐름**: `app_sky`·`sec_key` 입력창, 계좌 토글, 버튼별 상태 표시 등 UX 강화.
6. **Phase 5 – 안전한 실계좌 전환**: 다중 인증, 리스크 한도 슬라이더, REST 오류 복구, 비상 정지 플로우.
7. **Phase 6 – 고도화 및 다음 단계**: 
   - (a) REST 호출 최적화와 병렬 주문 파이프라인,
   - (b) GUI 기반 전략 프로필 편집기,
   - (c) 모듈형 배포(컨테이너/클라우드) 및 AutoML 실험 대시보드.

각 단계마다 단위·통합·회귀 테스트와 문서화를 병행하면서, GUI 중심 흐름이 유지되도록 체크리스트를 운영합니다.
